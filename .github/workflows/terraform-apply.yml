name: Terraform Infrastructure Deployment

on:
  push:
    branches: [ main ]

env:
  BUCKET_NAME: terraform-state-lorrylach-2025  
  AWS_REGION: us-east-1

jobs:
  bootstrap:
    name: Bootstrap AWS Backend
    runs-on: ubuntu-latest
    outputs:
      bucket_exists: ${{ steps.check_bucket.outputs.exists }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Check if S3 bucket exists
        id: check_bucket
        run: |
          echo "Vérification du bucket ${{ env.BUCKET_NAME }}..."
          if aws s3 ls "s3://${{ env.BUCKET_NAME }}" 2>&1 | grep -q 'NoSuchBucket\|An error occurred'; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Bucket n'existe pas - création nécessaire"
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Bucket existe déjà"
          fi
      - name: Create S3 bucket
        if: steps.check_bucket.outputs.exists == 'false'
        run: |
          echo "Création du bucket ${{ env.BUCKET_NAME }}..."
          aws s3 mb "s3://${{ env.BUCKET_NAME }}" --region ${{ env.AWS_REGION }}
          
          echo "Activation du versioning..."
          aws s3api put-bucket-versioning \
            --bucket "${{ env.BUCKET_NAME }}" \
            --versioning-configuration Status=Enabled
          
          echo "Activation du chiffrement..."
          aws s3api put-bucket-encryption \
            --bucket "${{ env.BUCKET_NAME }}" \
            --server-side-encryption-configuration '{
              "Rules": [{
                "ApplyServerSideEncryptionByDefault": {
                  "SSEAlgorithm": "AES256"
                }
              }]
            }'
          
          echo "Blocage de l'accès public..."
          aws s3api put-public-access-block \
            --bucket "${{ env.BUCKET_NAME }}" \
            --public-access-block-configuration \
            "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"
          
          echo "Bucket créé et configuré avec succès"
  terraform:
    name: Terraform Deployment
    runs-on: ubuntu-latest
    needs: bootstrap  
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.6.0  

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: |
          echo "Initialisation de Terraform..."
          terraform init
          echo "Terraform initialisé"
      - name: Terraform Format Check
        run: terraform fmt -check
        continue-on-error: true  

      - name: Terraform Validate
        run: |
          echo "Validation de la configuration..."
          terraform validate
          echo "Configuration valide"
      - name: Terraform Plan
        run: |
          echo "Génération du plan d'exécution..."
          terraform plan -out=tfplan
          echo "Plan généré"
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          echo "Application du plan Terraform..."
          terraform apply -auto-approve tfplan
          echo "Infrastructure déployée"
      - name: Output Terraform Results
        if: always()
        run: |
          echo "Affichage des outputs..."
          terraform output || echo "Aucun output disponible"
